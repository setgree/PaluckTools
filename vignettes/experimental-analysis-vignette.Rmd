---
title: "Analyzing experimental data"
output:
  rmarkdown::html_vignette:
    number_sections: true
    toc: true
    toc_depth: 3
    fig_width: 7
    fig_height: 7
vignette: >
  %\VignetteIndexEntry{4. Analyzing experimental data}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette demonstrates tools for analyzing experimental data: running multiple regression specifications with `tidy_lm()`, calculating cluster-robust standard errors with `robust_se()`, and preparing results for publication with `star_ready()`. For information on creating publication-ready tables, see the "Creating publication-ready tables" vignette.

# Example data: Growth mindset intervention

We'll use simulated data from a growth mindset intervention study with 2,000 students across 20 schools.

```{r simulate_data}
library(BLPlabtools)
library(dplyr, warn.conflicts = FALSE)

set.seed(123)

n_schools <- 20
n_per_school <- 100
n_total <- n_schools * n_per_school

experiment_data <- data.frame(
  student_id = 1:n_total,
  school_id = rep(1:n_schools, each = n_per_school),
  treatment = rep(c(rep(0, n_per_school/2), rep(1, n_per_school/2)), n_schools),
  baseline_score = rnorm(n_total, mean = 70, sd = 15),
  gender = sample(c("female", "male"), n_total, replace = TRUE),
  test_score = 70 + 5*rep(c(rep(0, n_per_school/2), rep(1, n_per_school/2)), n_schools) +
               rnorm(n_total, sd = 12),
  attendance = 0.85 + 0.03*rep(c(rep(0, n_per_school/2), rep(1, n_per_school/2)), n_schools) +
               rnorm(n_total, sd = 0.1),
  attitudes = 3.5 + 0.3*rep(c(rep(0, n_per_school/2), rep(1, n_per_school/2)), n_schools) +
              rnorm(n_total, sd = 0.8)
) |>
  mutate(
    treatment = factor(treatment, levels = c(0, 1), labels = c("Control", "Treatment")),
    gender = factor(gender)
  )

head(experiment_data)
```

# Running multiple regressions with `tidy_lm`

## Basic usage

```{r basic_tidy_lm}
results <- tidy_lm(
  data = experiment_data,
  dv = "test_score",
  terms = "treatment",
  treatment = "treatment"
)

results |> select(dv, treatmentTreatment_coef, treatmentTreatment_p)
```

## Multiple dependent variables

```{r multiple_dvs}
multi_outcome <- tidy_lm(
  data = experiment_data,
  dv = c("test_score", "attendance", "attitudes"),
  terms = "treatment",
  treatment = "treatment"
)

multi_outcome |> select(dv, treatmentTreatment_coef, treatmentTreatment_p)
```

## Different regression styles

The `style` parameter controls how `tidy_lm()` combines variables:

```{r regression_styles}
# "bivariate": treatment only
bivariate <- tidy_lm(
  data = experiment_data,
  dv = "test_score",
  terms = "treatment",
  style = "bivariate"
)

# "incremental": progressively add controls
incremental <- tidy_lm(
  data = experiment_data,
  dv = "test_score",
  terms = c("treatment", "baseline_score", "gender"),
  treatment = "treatment",
  style = "incremental"
)

# "default": all terms together
full_model <- tidy_lm(
  data = experiment_data,
  dv = "test_score",
  terms = c("treatment", "baseline_score", "gender"),
  treatment = "treatment",
  style = "default"
)

cat("Bivariate:", nrow(bivariate), "model\n")
cat("Incremental:", nrow(incremental), "models\n")
cat("Default:", nrow(full_model), "model\n")
```

# Cluster-robust standard errors

## Using `robust_se`

```{r robust_se}
model <- lm(test_score ~ treatment + baseline_score, data = experiment_data)
robust_results <- robust_se(model, cluster = experiment_data$school_id)

# robust_results[[1]] is the variance-covariance matrix
# robust_results[[2]] is the coefficient test with robust SEs
robust_results[[2]]
```

## Incorporating clusters into `tidy_lm`

```{r tidy_lm_clusters}
clustered_models <- tidy_lm(
  data = experiment_data,
  dv = c("test_score", "attendance"),
  terms = c("treatment", "baseline_score", "gender"),
  treatment = "treatment",
  clusters = "school_id",
  style = "incremental"
)

clustered_models |>
  select(dv, model_number, treatmentTreatment_coef, treatmentTreatment_se, treatmentTreatment_p)
```

# Preparing results for publication

The `star_ready()` function prepares `tidy_lm` output for `stargazer`:

```{r star_ready_demo, eval=FALSE}
models <- tidy_lm(
  data = experiment_data,
  dv = "test_score",
  terms = c("treatment", "baseline_score"),
  style = "incremental",
  clusters = "school_id"
)

ready_for_table <- star_ready(models, data = experiment_data)

library(stargazer)
stargazer(ready_for_table, type = "latex")
```

For detailed information on formatting tables, see the "Creating publication-ready tables" vignette.
